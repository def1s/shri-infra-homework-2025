name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Версия для деплоя"
        required: true

env:
  DOCKER_REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app

jobs:
  deploy:
    name: Deploy Job
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Docker login & verify image
        env:
          YC_SA_KEY: ${{ secrets.YC_SA_KEY }}
        run: |
          echo "$YC_SA_KEY" | docker login --username json_key --password-stdin cr.yandex
          IMAGE=${{ env.DOCKER_REGISTRY }}:${{ github.event.inputs.release_version }}_latest
          docker manifest inspect $IMAGE || {
            echo "::error::Docker image $IMAGE not found"
            exit 1
          }

      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            echo '${{ secrets.YC_SA_KEY }}' | docker login --username json_key --password-stdin cr.yandex

            REGISTRY="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app"
            TAG="${{ github.event.inputs.release_version }}_latest"
            IMAGE="$REGISTRY:$TAG"

            docker stop app || true
            docker rm app || true

            docker pull $IMAGE
            docker run -d --name app -p 80:3000 $IMAGE

      - name: Add deployment comment to issue
        if: github.event.repository.has_issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.release_version }}
        run: |
          ISSUE_NUMBER=$(gh issue list --search "Release v$VERSION" --json number -q '.[0].number')
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue comment "$ISSUE_NUMBER" \
              --body "**✅ Прод выкачан**  
          **Версия:** v$VERSION
          **Автор:** ${{ github.actor }}
          **Дата:** $(date +'%Y-%m-%d %H:%M')
          **Образ:** cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${VERSION}_latest"
          else
          echo "Issue not found, skipping comment"
          fi
